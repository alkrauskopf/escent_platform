<div id="content_panel">
	 <div style= "color:#000000; margin-top:5px; font-size:16px; font-weight:bold"> <center> <br/><br/>
	 </center></div>
	
    <div class="search-box" style="text-align:right; ; margin-bottom: 20px;">
        <%= text_field_tag "keywords", @keywords, :class => "text", :id => "content_keywords" %>
        <input id="search_button" type="button" class="fsn-button ui-button ui-state-default ui-corner-all" value="Search Library" style="margin-right:10px;"/>
		<button id="show_all_content" class="fsn-button ui-button ui-state-default ui-corner-all" style="display:none; margin-right:10px;">Show All Content</button>
		<%= button_to_remote  "Contribute Resource", {:update => "content_panel", :url => {:controller => :content, :action => :new, :organization_id => @current_organization}}, {:class => "fsn-button ui-button ui-state-default ui-corner-all", :style => "margin-right:10px;" } %>
		<!-- ALK Take out these buttons for now
		<%= button_to_remote  "Upload Resource By Frontend", {:update => "content_panel", :url => {:controller => :content, :action => :list_pending}}, {:class => "fsn-button ui-button ui-state-default ui-corner-all", :style => "margin-right:10px;" } %>		
		<%= button_to_remote  "Albums", {:update => "content_panel", :url => {:controller => :content_albums, :action => :index, :organization_id => @current_organization}}, {:class => "fsn-button ui-button ui-state-default ui-corner-all" } %>
    	-->
	</div>
    <br/>
    <br style="clear:both"/>
    <div id="result-box">
        <table class="tablesorter">
			<thead>
				<th>Title</td>
				<th>Type of Resource</td>
				<th> Current Usage </td>		
				<th>&nbsp;</td>
				<th>&nbsp;</td>				  
										
			</thead>			
            <tbody id="search-results">
                <% unless @contents.empty? %>
                <% for content in @contents do -%>
				<% unless content.nil? %>
					<% if content.user.nil? -%>
						<% submitter = "UNKNOWN CONTRIBUTOR" -%>
						<% else %>
						<% submitter = content.user.full_name -%>
					<% end -%>
                <tr id="<%= content.public_id %>">
                   	<td>
 			       	<div> 
					 	<span  style= "color:#C73914;"><center><strong><%= link_to content.title,{:controller => "site/site", :action => "static_resource", :organization_id => @current_organization, :id => content}%></strong></center></span>
					 	<span style= "color:#000000; font-weight:normal; font-size:11px"><center> Contributed By <%= submitter %> On <%= content.created_at.strftime("%B %d,%Y")%>
 						<br/><%= content.content_status.name.upcase %>
					 	<% if content.publish_end_date > Time.now%>, Expires in <%= time_ago_in_words(content.publish_end_date.to_s, include_seconds = false)%> <% end %>	
				     	<% if content.publish_end_date < Time.now%>, Expired  <%= time_ago_in_words(content.publish_end_date.to_s, include_seconds = false)%> ago <% end %>					
					 	</center></span>
					 </div>
					</td>
<!--                    <td>
            		<% if content.user%> <%= content.user.full_name %> <% else %> <i> *** Former User ***</i> <% end %>
                    </td> -->
                    <td>
                    <%= content.subject_area.name.humanize if content.subject_area %>&nbsp;
					<%= content.content_resource_type.name.humanize if content.content_resource_type %><br/>
					<%= content.content_object_type.content_object_type_group.name rescue "None" %>
					</td>
					<% if content.topics.size >1 %>
						<td style=" color: #C83A14; vertical-align:middle">
							<center><strong><%= pluralize(content.topics.size, "Topic")%></strong></center>
						</td>
						<% else %>
						<td>
						</td>
					<% end -%>
                    <td style="width:50px;  padding-top:0px;vertical-align:middle">

<!-- ALK: took out the @features.include?(content.id) inspection because it was generating inexplicable nil error -->
<!-- admin/search_results does the same redundant check successfully  -->

						<%= button_to_remote  "Delete", {:update => "content_panel", :url => {:controller => :content, :action => :destroy_anyway, :organization_id => @current_organization, :content_id => content},:confirm => "Are You Sure? Resource Will Be Permanently Removed! "}, {:class => "fsn-button ui-button ui-state-default ui-corner-all" } %>

                    </td> 

                    <td  style="width:50px;  padding-top:0px;vertical-align:middle">
                        <%= button_to_remote  "Edit", {:update => "content_panel", :url => {:controller => :content, :action => :edit, :organization_id => @current_organization, :content_id => content}}, {:class => "fsn-button ui-button ui-state-default ui-corner-all" } %>
                    </td>
                </tr>
				<% end -%>
                <% end -%>
                <% else %>
                <tr>
                    <td colspan="4" style="text-align:center;">
                        No Content
                    </td>
                </tr>
                <% end %>
            </tbody>
        </table>
        <div class="digg_pagination">
            <%= will_paginate @contents %>
        </div>
    </div>
</div>
<div id="view-content" title="View Content">
</div>
<script type="text/javascript">
    jQ(document).ready(function(){
        var $resultsBox = jQ("#search-results");
        var url = '<%= url_for :controller => :content, :action => :search, :organization_id => @current_organization %>';
        var AUTH_TOKEN = "<%= protect_against_forgery? ? form_authenticity_token : '' %>";
        jQ.ajaxSetup({
            data: {
                authenticity_token: AUTH_TOKEN
            }
        });
        
        function showDialogContent(title, content_id){
            $dialog = jQ("#view-content");
            // next line is broken.		
            $dialog.attr("title", title);
            jQ.post('<%= url_for :controller => :content, :action => :show, :organization_id => @current_organization %>', {
                'id': content_id
            }, function(data){
                $dialog.html(data);
                $dialog.dialog('open');
            })
        }
        
        var addButtonAction = function(){
            jQ("button", jQ("#result-box")).each(function(){
                jQ(this).click(function(){
                    var title = jQ(this).parent("td").parent("tr").children("td").eq(0).text();
                    var content_id = jQ(this).parent("td").parent("tr").attr("id");
                    showDialogContent(title, content_id)
                    return false;
                })
            })
			
            jQ("#show_all_content").click(function(){
				jQ("#content_keywords").attr("value","");
				jQ("#show_all_content").css("display", "none");
				search_content(url,"");
                return false;	
            })
        }
        
        function search_content(url, keywords){
            jQ.get(url, {
                'keywords': keywords,
                'render_html': 'search_results'
            }, function(data){
                jQ('#result-box').html(data)
                addButtonAction();
            });
        }
        
        jQ("#search_button").click(function(){
            var keywords = jQ("input[name='keywords']", jQ(this).parent("div")).val();
			
			if(keywords.length == 0){
				jQ("#show_all_content").css("display", "none");				
			}else{
				jQ("#show_all_content").css("display", "block");			
			}

            search_content(url, keywords);
        });
        
        jQ("#content_keywords").keyup(function(event){
            if (event.keyCode == 13) {
                var keywords = jQ(this).val();
                search_content(url, keywords);
            }
        });
        
        addButtonAction();
        
        search_content(url, '');
        
        jQ("#view-content").dialog({
            bgiframe: true,
            autoOpen: false,
            width: 500,
            modal: true,
            buttons: {
                Close: function(){
                    jQ(this).dialog('close');
                }
            }
        });
        
        jQ('div#result-box div.pagination a').live('click', function(){
            jQ('#result-box').load(this.href, function(){
                addButtonAction();
            });
            return false
        })
    })
</script>
